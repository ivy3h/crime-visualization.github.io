<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>US Crime Data Visualization (2020-2024)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            line-height: 1.6;
            color: #ffffff;
            background: #000000;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        /* Grid background effect */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        header {
            text-align: center;
            padding: 80px 20px 60px;
            color: #ffffff;
            animation: fadeInDown 1s ease;
            border-bottom: 2px solid #555555;
            margin-bottom: 40px;
            position: relative;
        }

        header::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 2px;
            background: #ff0000;
            animation: expandLine 2s ease-in-out infinite;
        }

        @keyframes expandLine {
            0%, 100% { width: 0; }
            50% { width: 300px; }
        }

        h1 {
            font-size: 3.5em;
            margin-bottom: 20px;
            letter-spacing: 3px;
            font-weight: bold;
            color: #ffffff;
        }

        .glitch {
            position: relative;
            display: inline-block;
        }

        .subtitle {
            font-size: 1.3em;
            color: #ffffff;
            font-weight: 300;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .date-range {
            display: inline-block;
            background: rgba(255, 255, 255, 0.1);
            padding: 12px 30px;
            border: 2px solid #ffffff;
            margin-top: 20px;
            color: #ffffff;
            font-weight: bold;
            letter-spacing: 1px;
        }

        .content {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #555555;
            padding: 40px;
            margin: 40px 0;
            animation: fadeInUp 1s ease;
            position: relative;
        }

        .content::before,
        .content::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border: 2px solid #ffffff;
        }

        .content::before {
            top: -2px;
            left: -2px;
            border-right: none;
            border-bottom: none;
        }

        .content::after {
            bottom: -2px;
            right: -2px;
            border-left: none;
            border-top: none;
        }

        .section {
            margin-bottom: 50px;
        }

        h2 {
            color: #ffffff;
            margin-bottom: 20px;
            font-size: 2em;
            border-bottom: 2px solid #555555;
            padding-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .description {
            font-size: 1.1em;
            color: #ffffff;
            margin-bottom: 30px;
            line-height: 1.8;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .visualizations-grid {
		    display: grid;
		    grid-template-columns: repeat(2, 1fr); 
		    gap: 30px;
		    margin-top: 30px;
		}

        .viz-card {
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #555555;
            padding: 30px;
            color: #ffffff;
            transition: all 0.3s ease;
            cursor: pointer;
            text-decoration: none;
            display: block;
            position: relative;
            overflow: hidden;
        }

        .viz-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .viz-card:hover::before {
            left: 100%;
        }

        .viz-card:hover {
            border-color: #ffffff;
            transform: translateY(-5px);
        }

        .viz-hint {
            font-size: 0.8em;
            color: #cccccc;
            margin-top: 10px;
            letter-spacing: 0.5px;
        }

        .what-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .what-help-button {
            padding: 6px 14px;
            border: 1px solid #888;
            background: transparent;
            color: #fff;
            font-size: 0.8em;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: border-color 0.2s ease;
        }

        .what-help-button[aria-expanded="true"] {
            border-color: #fff;
        }

        .what-help-panel {
            display: none;
            margin-top: 12px;
            padding: 12px 16px;
            border: 1px solid #555;
            background: rgba(255, 255, 255, 0.05);
            font-size: 0.9em;
            line-height: 1.6;
        }

        .what-help-panel ul {
            padding-left: 20px;
        }

        .viz-card h3 {
            font-size: 1.5em;
            margin-bottom: 15px;
            color: #ffffff;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .viz-card:hover h3 {
            color: #cccccc;
        }

        .viz-card p {
            opacity: 0.9;
            line-height: 1.6;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .viz-note {
            font-size: 0.85em;
            color: #cccccc;
            margin-bottom: 12px;
            letter-spacing: 0.5px;
        }

        .viz-select {
            background: rgba(0, 0, 0, 0.8);
            color: #ffffff;
            border: 1px solid #555555;
            padding: 4px 8px;
            font-size: 0.85em;
            margin-left: 6px;
        }

        .what-grid-wrapper {
            position: relative;
        }

        .filter-chip {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 6px 14px;
            border: 1px solid #ffffff;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.08);
            color: #ffffff;
            font-size: 0.85em;
            margin-bottom: 18px;
        }

        .filter-chip button {
            background: transparent;
            border: none;
            color: #ffffff;
            font-weight: bold;
            cursor: pointer;
            font-size: 1em;
            line-height: 1;
        }

        .chart {
            width: 92%;
            min-height: 420px;
            height: 100%;
            margin: 0 auto;
        }

        .viz-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }

        .feature {
            padding: 25px;
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid #555555;
            border-left: 4px solid #ffffff;
            transition: all 0.3s ease;
        }

        .feature:hover {
            border-color: #ffffff;
            transform: translateX(5px);
        }

        .feature h3 {
            color: #ffffff;
            margin-bottom: 10px;
            text-transform: uppercase;
            font-size: 1.1em;
        }

        .feature p {
            color: #ffffff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        footer {
            text-align: center;
            padding: 40px 20px;
            color: #ffffff;
            border-top: 2px solid #555555;
            margin-top: 40px;
        }

        .collapsed {
            display: none;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        
        .expanded {
            display: block;
            opacity: 1;
            transition: opacity 0.5s ease;
        }
        
        .github-link {
            display: inline-block;
            background: transparent;
            color: #ffffff;
            padding: 12px 30px;
            border: 2px solid #ffffff;
            text-decoration: none;
            font-weight: bold;
            margin-top: 20px;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .github-link:hover {
            background: #ffffff;
            color: #000000;
        }

        .attributes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }

        .attr-category {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid #555555;
            border-left: 4px solid #ffffff;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .attr-category:hover {
            border-left-color: #cccccc;
            transform: translateX(5px);
        }

        .attr-category h4 {
            color: #ffffff;
            font-size: 1em;
            margin-bottom: 15px;
            letter-spacing: 1px;
            font-family: 'Courier New', monospace;
        }

        .attr-item {
            font-size: 0.9em;
            color: #ffffff;
            margin-bottom: 8px;
            line-height: 1.5;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .attr-key {
            color: #ffffff;
            font-weight: bold;
            font-family: 'Courier New', monospace;
        }

        .map-container {
            position: relative;
            margin-top: 20px;
        }

        .map-overlay {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 10;
        }

        .where-block .map-overlay {
            position: absolute;
            left: 0px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 9999;
        }

        .where-block .fullscreen-btn {
            writing-mode: vertical-rl;
            transform: rotate(180deg);
            background: rgba(255,255,255,0.85);
            padding: 10px 6px;
            font-size: 11px;
            border-radius: 6px 6px 6px 6px;
            border: 1px solid #444;
            color: black;
            text-decoration: none;
            transition: 0.2s;
            cursor: pointer;
        }

        .where-block .fullscreen-btn:hover {
            background: #fff;
            box-shadow: 0 0 8px rgba(255,255,255,0.7);
        }

        .fullscreen-btn {
            display: inline-block;
            background: rgba(0, 0, 0, 0.9);
            color: #ffffff;
            padding: 10px 20px;
            border: 2px solid #ffffff;
            text-decoration: none;
            font-weight: bold;
            font-size: 0.9em;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-family: 'Courier New', monospace;
        }

        .fullscreen-btn:hover {
            background: #ffffff;
            color: #000000;
        }

        .scanline {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                to bottom,
                rgba(255, 255, 255, 0) 50%,
                rgba(0, 0, 0, 0.1) 50%
            );
            background-size: 100% 4px;
            pointer-events: none;
            animation: scanlines 8s linear infinite;
            z-index: 999;
        }

		.viz-card img {
		    cursor: pointer;
		    transition: transform 0.3s ease;
		}
		
		.viz-card img:hover {
		    transform: scale(1.05);
		}
		
		.image-modal {
		    display: none;
		    position: fixed;
		    z-index: 1000;
		    left: 0;
		    top: 0;
		    width: 100%;
		    height: 100%;
		    background-color: rgba(0,0,0,0.9);
		    justify-content: center;
		    align-items: center;
		}
		
		.image-modal img {
		    max-width: 90%;
		    max-height: 90%;
		    border: 3px solid #ffffff;
		}
		
		.image-modal.show {
		    display: flex;
		    animation: fadeIn 0.3s ease;
		}
		
		@keyframes fadeIn {
		    from { opacity: 0; }
		    to { opacity: 1; }
		}
		
        @keyframes scanlines {
            0% { transform: translateY(0); }
            100% { transform: translateY(4px); }
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2em;
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            }
            
            .content {
                padding: 25px;
            }
            
            .visualizations-grid {
			    display: grid;
			    grid-template-columns: repeat(2, 1fr); /* 2 columns */
			    gap: 20px; /* spacing between charts */
			    margin-top: 20px;
			}
        }
    </style>
    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
</head>
<body>
    <div class="scanline"></div>
    
    <div class="container">
        <header>
            <h1 class="glitch">US CRIME DATA</h1>
            <p class="subtitle">â€” CS 6730: Data Vis Principles â€”</p>
            <div class="date-range">[Team: SMOOTH CRIMINAL]</div>
        </header>

        <div class="content">
            <section class="section">
                <h2>MISSION BRIEFING</h2>
                <p class="description">
Crime in the United States affects community safety, policy, and urban planning, yet existing tools focus on isolated incidents and aggregated statistics remain hard to interpret. Our project bridges this gap by visualizing crime data from 2020â€”2024 to reveal spatial and temporal patterns, with the goal to make complex data intuitive and actionable for researchers, policymakers, and the public.
                </p>
            </section>

            <section class="section">
                <h2>DATA ATTRIBUTES</h2>
                    <p class="description">
                        The dataset contains 28 attributes describing each crime incident, covering core identifiers, classification, victim details, and spatial context.
                    </p>
                    <div class="attributes-grid">
                        <div class="attr-category">
                            <h4>CORE CRIME INFORMATION</h4>
                            <div class="attr-item"><span class="attr-key">DR_NO:</span> Unique identifier for each reported crime</div>
                            <div class="attr-item"><span class="attr-key">Date Rptd:</span> Date the crime was reported</div>
                            <div class="attr-item"><span class="attr-key">DATE OCC:</span> Date the crime occurred</div>
                            <div class="attr-item"><span class="attr-key">TIME OCC:</span> Time the crime occurred</div>
                            <div class="attr-item"><span class="attr-key">AREA:</span> Geographic area or precinct</div>
                            <div class="attr-item"><span class="attr-key">AREA NAME:</span> Descriptive name of the area</div>
                            <div class="attr-item"><span class="attr-key">Rpt Dist No:</span> Reporting district number</div>
                        </div>
                        
                        <div class="attr-category">
                            <h4>CRIME CLASSIFICATION</h4>
                            <div class="attr-item"><span class="attr-key">Part 1-2:</span> Severity classification (Part 1: serious, Part 2: less serious)</div>
                            <div class="attr-item"><span class="attr-key">Crm Cd:</span> Crime code or classification number</div>
                            <div class="attr-item"><span class="attr-key">Crm Cd Desc:</span> Description of the crime code</div>
                            <div class="attr-item"><span class="attr-key">Mocodes:</span> Motivations or circumstances</div>
                        </div>
                        
                        <div class="attr-category">
                            <h4>VICTIM INFORMATION</h4>
                            <div class="attr-item"><span class="attr-key">Vict Age:</span> Age of the victim</div>
                            <div class="attr-item"><span class="attr-key">Vict Sex:</span> Sex of the victim</div>
                            <div class="attr-item"><span class="attr-key">Vict Descent:</span> Racial or ethnic background</div>
                        </div>
                        
                        <div class="attr-category">
                            <h4>LOCATION & CONTEXT</h4>
                            <div class="attr-item"><span class="attr-key">Premis Cd:</span> Premises code (e.g., residential, commercial)</div>
                            <div class="attr-item"><span class="attr-key">Premis Desc:</span> Description of the premises</div>
                            <div class="attr-item"><span class="attr-key">Weapon Used Cd:</span> Code for weapon used (if any)</div>
                            <div class="attr-item"><span class="attr-key">Weapon Desc:</span> Description of the weapon</div>
                        </div>
                        
                        <div class="attr-category">
                            <h4>ADDITIONAL INFORMATION</h4>
                            <div class="attr-item"><span class="attr-key">Status:</span> Current case status (e.g., open, closed)</div>
                            <div class="attr-item"><span class="attr-key">Status Desc:</span> Description of case status</div>
                            <div class="attr-item"><span class="attr-key">Crm Cd 1-4:</span> Additional crime codes if applicable</div>
                            <div class="attr-item"><span class="attr-key">LOCATION:</span> General location of the crime</div>
                            <div class="attr-item"><span class="attr-key">Cross Street:</span> Intersection or nearby street</div>
                            <div class="attr-item"><span class="attr-key">LAT, LON:</span> GPS coordinates of crime location</div>
                        </div>
                    </div>
                </div>
            </section>

            <section class="section where-block">
                <h2>Where: Geographic Analysis</h2>

                <!-- 1) Point-level cluster + heatmap (where_map_simple) -->
                <div class="description">
                    <p style="margin-bottom: 20px;">
                        A point-level cluster heatmap showing full incident coverage, useful for quick city wide hotspot awareness. Downtown LA is the area with the strongest concentration of crime incidents.
                    </p>
                </div>
                <div class="map-container">
                    <iframe src="where_map_simple.html" 
                        frameborder="0" 
                        style="width: 100%; height: 600px; border: 2px solid #555555; background: #000000;">
                    </iframe>
                    <div class="map-overlay">
                        <a href="where_map_simple.html" target="_blank" class="fullscreen-btn">
                            >> OPEN FULL SCREEN <<
                        </a>
                    </div>
                </div>

                <!-- 2) Area-level choropleth (la_area_choropleth.html) -->
                <div class="description" style="margin-top: 40px;">
                    <p style="margin-bottom: 20px;">
                        Quantile-binned choropleth where color intensity encodes incident volume by administrative area. Hover to inspect rank and share of citywide crime to compare area-level risk.
                    </p>
                </div>
                <div class="map-container">
                    <iframe src="la_area_choropleth.html" 
                            frameborder="0" 
                            style="width: 100%; height: 600px; border: 2px solid #555555; background: #000000;">
                    </iframe>
                    <div class="map-overlay">
                        <a href="la_area_choropleth.html" target="_blank" class="fullscreen-btn">
                            >> OPEN FULL SCREEN <<
                        </a>
                    </div>
                </div>

                <!-- 3) Hexbin patrol hotspot map (la_hexbin_patrol_map.html) -->
                <div class="description" style="margin-top: 40px;">
                    <p style="margin-bottom: 20px;">
                        Hexbin-based hotspot map where each cell encodes long term crime density and composition. Click to pin a cell and compare it against hovered cells using the side info panel to support patrol planning.
                    </p>
                </div>
                <div class="map-container">
                    <iframe src="la_hexbin_patrol_map.html" 
                            frameborder="0" 
                            style="width: 100%; height: 600px; border: 2px solid #555555; background: #000000;">
                    </iframe>
                    <div class="map-overlay">
                        <a href="la_hexbin_patrol_map.html" target="_blank" class="fullscreen-btn">
                            >> OPEN FULL SCREEN <<
                        </a>
                    </div>
                </div>

            </section>

			<section class="section">
                <h2>When: TEMPORAL ANALYSIS</h2>

                <div class="description">
                    <ul>
                        <li><strong>Hourly patterns:</strong> Peak criminal activity occurs around midday (12:00 PM), with lower crime rates between midnight and 7:00 AM, contrary to common perceptions about nighttime danger.</li>
                        <li><strong>Weekly patterns:</strong> Fridays show the highest incidence of reported crimes.</li>
                        <li><strong>Monthly patterns:</strong> January shows the highest crime levels.</li>
                        <li><strong>Yearly trends:</strong> Crime incidents increased from 2020 through early 2022, peaked in 2022, then dramatically decreased beginning in 2024.</li>
                    </ul>
                </div>

                <div style="margin-top: 30px; overflow: hidden;">
                    <object data="when_temporal_analysis.html" 
                            type="text/html" 
                            style="width: 100%; height: 1200px; display: block; overflow: hidden;">
                    </object>
                </div>
            </section>  

            <section class="section">
                <div class="what-header">
			        <h2>WHAT: CATEGORICAL ANALYSIS</h2>
                    <button id="whatHelpToggle" class="what-help-button" aria-expanded="false" aria-controls="whatHelpPanel">
                        HOW TO INTERACT
                    </button>
                </div>
                <div id="whatHelpPanel" class="what-help-panel" role="status" aria-live="polite">
                    <ul>
                        <li>Click bars to filter across the section; double-click the plot background to reset.</li>
                        <li>Use the sort menus to reorder heatmap axes or status nodes for easier comparisons.</li>
                        <li>Hover any mark to read precise counts, rankings, and shares before discussing insights.</li>
                    </ul>
                </div>
			
			    <div class="description">
			        <ul>
			            <li><strong>Crime types:</strong> Hover the Pareto bars to see how quickly the top incidents accumulate.</li>
			            <li><strong>Hierarchies:</strong> Use the sunburst to drill from Part 1/Part 2 down to the leading offense descriptions.</li>
			            <li><strong>Weapons & scenes:</strong> The heatmap highlights common weaponâ€“premises pairings.</li>
			            <li><strong>Case pipeline:</strong> The Sankey lays out how major offense types flow into status outcomes.</li>
			        </ul>
			    </div>
                <div id="what-filter-chip" class="filter-chip" style="display:none;" aria-live="polite">
                    <span id="what-filter-chip-text"></span>
                    <button type="button" id="clearWhatFilter" aria-label="Clear linked filter">Ã—</button>
                </div>
			
                <div class="what-grid-wrapper">
			        <div class="visualizations-grid">
			            <div class="viz-card">
			                <h3>Crime Types Pareto</h3>
			                <div id="crime-type-chart" class="chart" data-what-chart aria-label="Top crime types Pareto chart"></div>
                            <p class="viz-hint">Click any bar to spotlight that crime across all charts; double-click the plot background or use the filter chip to clear.</p>
			            </div>
			            <div class="viz-card">
			                <h3>Severity to Offense Drilldown</h3>
			                <div id="crime-hierarchy-chart" class="chart" data-what-chart aria-label="Crime hierarchy sunburst"></div>
                            <p class="viz-hint">Hover to see each Part â†’ Crime share; selections from the Pareto view automatically emphasize the chosen crime here.</p>
			            </div>
			            <div class="viz-card">
			                <h3>Weapons Ã— Premises</h3>
			                <div style="display:flex; justify-content:flex-end; gap:10px; align-items:center; margin-bottom:12px;">
                                <label style="font-size:0.8em;">Sort
                                    <select id="weaponSort" class="viz-select">
                                        <option value="default">Default</option>
                                        <option value="desc">By total</option>
                                    </select>
                                </label>
                            </div>
			                <div id="weapon-premise-chart" class="chart" data-what-chart aria-label="Weapon versus premises heatmap"></div>
                            <p class="viz-hint">Use the Sort control to reorder rows/columns by current totals and hover cells to inspect specific weaponâ€“premise volumes.</p>
			            </div>
			            <div class="viz-card">
			                <h3>Status Pipeline</h3>
                        <div style="display:flex; justify-content:flex-end; gap:10px; align-items:center; margin-bottom:12px;">
                                <label style="font-size:0.8em;">Status order
                                    <select id="statusSort" class="viz-select">
                                        <option value="default">Default</option>
                                        <option value="desc">By total</option>
                                    </select>
                                </label>
                            </div>
			                <div id="status-sankey-chart" class="chart" data-what-chart aria-label="Crime status Sankey diagram"></div>
                            <p class="viz-hint">Switch Status order to change node sorting; when a Pareto bar is selected this view filters to that crimeâ€™s outcome flow.</p>
			            </div>
			        </div>
                </div>
				</section>
				
			<section class="section">
                <h2>WHO: DEMOGRAPHICS ANALYSIS</h2>
                
                <div class="description">
                    <ul>
                        <li><strong>Gender distribution:</strong> Males comprise 47.0% of victims, females 42.8%.</li>
                        <li><strong>Age patterns:</strong> Victims are predominantly young adults, with median age of 30 and mean age of 29.1.</li>
                        <li><strong>Population pyramid:</strong> Bi-directional bar chart showing age-sex distribution.</li>
                        <li><strong>Crime-demographic relationships:</strong> Property crimes (vehicle theft, burglary) disproportionately affect younger victims (25-34), while violent crimes show broader age distribution.</li>
                        <li><strong>Age distribution insights:</strong> Violin plots reveal victim age patterns - wider sections indicate more common ages for each crime type.</li>
                    </ul>
                </div>
                
                <div class="visualizations-grid">
                    <!-- Population Pyramid (Full Width) -->
                    <div class="viz-card" style="grid-column: 1 / -1;">
                        <h3>ðŸ‘¥ Population Pyramid: Age-Sex Distribution</h3>
                        <div id="pyramid-viz" class="chart"></div>
                        <p class="viz-hint">Click any bar to filter all visualizations by that age-sex group. Males (left/blue) vs Females (right/red). Hover for exact counts.</p>
                    </div>

                    <!-- Demographic Mix by Crime Type -->
                    <div class="viz-card">
                        <h3>ðŸ“Š Demographic Mix by Crime Type</h3>
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
                            <label style="font-size: 0.9em; color: #ffffff;">Group by:</label>
                            <select id="demo-grouping" style="background: rgba(0,0,0,0.8); color: #ffffff; border: 1px solid #555555; padding: 6px 12px; font-size: 0.9em; font-family: 'Courier New', monospace; cursor: pointer;">
                                <option value="sex">Sex (M/F/X)</option>
                                <option value="descent">Descent (Ethnicity)</option>
                            </select>
                        </div>
                        <div id="crime-demo-viz" class="chart"></div>
                        <p class="viz-hint">Shows victim demographic composition for top 6 crime types. Toggle between sex and descent to explore different demographic patterns. Stacked bars show proportional distribution.</p>
                    </div>

                    <!-- Age Distribution by Crime Type -->
                    <div class="viz-card">
                        <h3>ðŸ“ˆ Age Distribution by Crime Type</h3>
                        <div id="age-dist-viz" class="chart"></div>
                        <p class="viz-hint">Violin plots reveal age distribution patterns for top 8 crimes. Wider sections = more common ages. Box shows quartiles, thick line = median victim age. Compare shapes to see how age risk varies by crime.</p>
                    </div>
                </div>
				</section>			

<section class="section">
    <h2>MULTIDIMENSIONAL ANALYSIS</h2>
<div class="description">
    <p style="margin-bottom: 20px;">
        A unified multidimensional analysis integrating spatial, temporal, categorical, and victim/weapon attributes. 
        Explore how crime patterns shift when multiple dimensions interact, with dynamic filtering and coordinated visualizations.
    </p>

    <ul>
        <li><strong>Spatialâ€“temporal correlations:</strong> Crime density clusters concentrate around Downtown and Hollywood, with Friday evening peaks and consistently lower early-morning activity across all regions.</li>

        <li><strong>Crimeâ€“victim interactions:</strong> Property-related offenses dominate younger victims, while violent crimes occur more frequently among adults aged 25â€“40.</li>

        <li><strong>Weaponâ€“location dynamics:</strong> Firearm-related incidents are highly concentrated along specific hotspot corridors, while strong-arm cases are more evenly distributed across residential areas.</li>

        <li><strong>Cross-dimensional behavior shifts:</strong> Filtering by time-of-day and neighborhood shows dramatic shiftsâ€”vehicle thefts peak in the afternoon, whereas burglary and vandalism increase during late-night hours.</li>
    </ul>
</div>

    <div class="map-container" style="margin-top: 30px;">
        <iframe src="multidimensional.html"
                frameborder="0"
                style="width: 100%; height: 900px; border: 2px solid #555555; background: #000000;">
        </iframe>

        <div class="map-overlay">
            <a href="multidimensional.html" target="_blank" class="fullscreen-btn">
                >> OPEN FULL SCREEN <<
            </a>
        </div>
    </div>
</section>
            <section class="section">
                <h2>DATA SOURCES</h2>
                <p class="description">
                U.S. Crime Dataset (January 2020 â€” September 2024). Source: <a href="https://www.kaggle.com/datasets/arpitsinghaiml/u-s-crime-dataset" target="_blank" style="color: #ffffff; text-decoration: underline;">Kaggle</a>
                </p>
            </section>
        </div>

        <footer>
            <p style="font-size: 1.2em; letter-spacing: 2px;">[ DATA VISUALIZATION TACTICAL UNIT ]</p>
            <p style="margin-top: 10px; font-size: 0.9em; color: #ffffff;">OPERATIONAL TIMELINE: JAN 2020 â€” SEPT 2024</p>
            <a href="https://github.com/ivy3h/crime-visualization.github.io" class="github-link" target="_blank">
                >> ACCESS REPOSITORY <<
            </a>
        </footer>
    </div>

<footer style="text-align:center; margin-top:50px; padding:20px; color:#555; font-size:14px;">
    <p><strong>Team Name:</strong> SMOOTH CRIMINAL</p>
    <p><strong>Team Members:</strong> Chunzhen Hu, Ivy He, Yuxing Sun, Yangsheng Zhou, Muzhi Liu, Bei Liu</p>
    <p style="margin-top:10px;">Georgia Institute of Technology Â· 2025</p>
</footer>

<div id="imageModal" class="image-modal" onclick="closeModal()">
    <img id="modalImage" src="">
</div>

<script>
const modal = document.getElementById("imageModal");
const modalImg = document.getElementById("modalImage");

document.querySelectorAll(".viz-card img").forEach(img => {
    img.addEventListener("click", () => {
        modalImg.src = img.src;
        modal.classList.add("show");
    });
});

function closeModal() {
    modal.classList.remove("show");
}

function toggleAttributes() {
    const section = document.getElementById("attributes");
    const title = document.getElementById("attr-title");

    if (section.classList.contains("collapsed")) {
        section.classList.remove("collapsed");
        section.classList.add("expanded");
        title.innerHTML = "DATA ATTRIBUTES â–²";
    } else {
        section.classList.remove("expanded");
        section.classList.add("collapsed");
        title.innerHTML = "DATA ATTRIBUTES â–¼";
    }
}

function toggleTemporal() {
    const section = document.getElementById("temporal-content");
    const title = document.getElementById("temporal-title");

    if (section.classList.contains("collapsed")) {
        section.classList.remove("collapsed");
        section.classList.add("expanded");
        title.innerHTML = "TEMPORAL & CATEGORICAL ANALYSIS â–²";
    } else {
        section.classList.remove("expanded");
        section.classList.add("collapsed");
        title.innerHTML = "TEMPORAL & CATEGORICAL ANALYSIS â–¼";
    }
}

const WHAT_CHART_SELECTOR = "[data-what-chart]";
const DEFAULT_START_MONTH = "2022-10";
const DEFAULT_END_MONTH = "2024-09";

const plotlyBaseLayout = {
    paper_bgcolor: "rgba(0,0,0,0)",
    plot_bgcolor: "rgba(0,0,0,0)",
    font: {
        color: "#ffffff",
        family: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif"
    }
};

const plotlyConfig = {
    responsive: true,
    displaylogo: false,
    displayModeBar: false,
    staticPlot: false,
    scrollZoom: false
};


// WHO section state and constants
const whoState = {
    rawData: [],
    filteredData: [],
    selectedDemographic: null,
    currentGrouping: 'sex'
};

const WHO_AGE_BINS = [
    { min: 0, max: 17, label: '0-17' },
    { min: 18, max: 24, label: '18-24' },
    { min: 25, max: 34, label: '25-34' },
    { min: 35, max: 44, label: '35-44' },
    { min: 45, max: 54, label: '45-54' },
    { min: 55, max: 64, label: '55-64' },
    { min: 65, max: 100, label: '65+' }
];

const DESCENT_LABELS = {
    'H': 'Hispanic/Latino',
    'W': 'White',
    'B': 'Black',
    'A': 'Asian',
    'O': 'Other',
    'X': 'Unknown',
    'F': 'Filipino',
    'C': 'Chinese',
    'J': 'Japanese',
    'K': 'Korean',
    'V': 'Vietnamese',
    'I': 'American Indian',
    'U': 'Hawaiian',
    'P': 'Pacific Islander',
    'S': 'Samoan',
    'D': 'Cambodian',
    'L': 'Laotian',
    'Z': 'Asian Indian'
};



const titleCase = (label = "") =>
    label
        .toLowerCase()
        .replace(/\b([a-z])/g, (match) => match.toUpperCase());

const cleanLabel = (label = "") =>
    titleCase(label)
        .replace(/\s{2,}/g, " ")
        .trim();

const hexToRGBA = (hex, alpha = 1) => {
    const sanitized = hex.replace("#", "");
    const bigint = parseInt(sanitized, 16);
    const r = (bigint >> 16) & 255;
    const g = (bigint >> 8) & 255;
    const b = bigint & 255;
    return `rgba(${r}, ${g}, ${b}, ${alpha})`;
};

const monthWithin = (month, start, end) =>
    (!start || month >= start) && (!end || month <= end);

const matchesCrimeFilter = (crime, filters) => {
    if (filters.selectedCrime) {
        return crime === filters.selectedCrime;
    }
    if (filters.crimeType && filters.crimeType !== "all") {
        return crime === filters.crimeType;
    }
    return true;
};

const filterSlices = (slices, filters) => {
    if (!slices?.length) {
        return [];
    }
    return slices.filter(
        (slice) =>
            monthWithin(slice.month, filters.start, filters.end) &&
            filters.sexes.has(slice.sex) &&
            matchesCrimeFilter(slice.crime, filters)
    );
};

const whatState = {
    data: null,
    filters: {
        start: DEFAULT_START_MONTH,  
        end: DEFAULT_END_MONTH,
        sexes: new Set(["M", "F", "O"]),
        crimeType: "all",
        selectedCrime: null,
        weaponSort: "default",
        statusSort: "default"
    }
};

function getSelectedSexSet() {
    return new Set(["M", "F", "O"]);
}

async function initWhatVisuals() {
    const placeholders = document.querySelectorAll(WHAT_CHART_SELECTOR);
    if (!placeholders.length || typeof Plotly === "undefined") {
        return;
    }

    placeholders.forEach((el) => {
        el.innerHTML = "";
    });

    try {
        const response = await fetch("./data/what_insights.json");
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        const data = await response.json();
        whatState.data = data;
        updateFiltersFromControls({ clearSelection: true, skipRender: true });
        updateWhatFilterChip();
        updateWhatCharts();
    } catch (error) {
        console.error("Failed to load categorical data", error);
        placeholders.forEach((el) => {
            el.innerHTML =
                '<p class="viz-note">âš  Unable to load categorical data.</p>';
        });
    }
}



function updateFiltersFromControls({ clearSelection = false, skipRender = false } = {}) {
    whatState.filters.weaponSort =
        document.getElementById("weaponSort")?.value || "default";
    whatState.filters.statusSort =
        document.getElementById("statusSort")?.value || "default";

    if (clearSelection) {
        whatState.filters.selectedCrime = null;
    }

    if (!skipRender) {
        updateWhatFilterChip();
        updateWhatCharts();
    }
}

function updateWhatFilterChip() {
    const chip = document.getElementById("what-filter-chip");
    const text = document.getElementById("what-filter-chip-text");
    if (!chip || !text) return;
    const activeCrime = whatState.filters.selectedCrime;
    if (activeCrime) {
        chip.style.display = "inline-flex";
        text.textContent = `Crime filter: ${cleanLabel(activeCrime)}`;
    } else {
        chip.style.display = "none";
        text.textContent = "";
    }
}

function renderEmptyState(targetId, message) {
    const el = document.getElementById(targetId);
    if (!el) return;
    if (window.Plotly && el.data) {
        Plotly.purge(el);
    }
    el.innerHTML = `<p class="viz-note">${message}</p>`;
}

function updateWhatCharts() {
    if (!whatState.data) return;
    const tasks = [
        renderCrimeParetoFiltered,
        renderCrimeSunburstFiltered,
        renderWeaponPremiseFiltered,
        renderStatusSankeyFiltered
    ];
    let taskIndex = 0;

    const runNext = () => {
        if (taskIndex >= tasks.length) {
            return;
        }
        const task = tasks[taskIndex++];
        requestAnimationFrame(() => {
            try {
                task();
            } finally {
                runNext();
            }
        });
    };

    runNext();
}

function renderCrimeParetoFiltered() {
    const filtersForPareto = {
        ...whatState.filters,
        // Keep the selection visual highlight only; don't filter the Pareto bars down
        selectedCrime: null
    };
    const filtered = filterSlices(
        whatState.data?.crime_types?.slices,
        filtersForPareto
    );
    if (!filtered.length) {
        renderEmptyState("crime-type-chart", "No incidents for current filters.");
        return;
    }

    const totalsMap = new Map();
    filtered.forEach((slice) => {
        totalsMap.set(slice.crime, (totalsMap.get(slice.crime) || 0) + slice.count);
    });

    const totals = Array.from(totalsMap.entries())
        .map(([crime, count]) => ({ crime, count }))
        .sort((a, b) => b.count - a.count);

    const totalIncidents = totals.reduce((sum, item) => sum + item.count, 0);
    const labels = totals.map((item) => cleanLabel(item.crime));
    const counts = totals.map((item) => item.count);
    const shares = totals.map((item) =>
        totalIncidents ? Number(((item.count / totalIncidents) * 100).toFixed(2)) : 0
    );
    const cumulative = [];
    counts.reduce((running, value, idx) => {
        const next = running + value;
        cumulative[idx] = Number(((next / totalIncidents) * 100).toFixed(2));
        return next;
    }, 0);

    const highlightCrime =
        whatState.filters.selectedCrime ||
        (whatState.filters.crimeType !== "all" ? whatState.filters.crimeType : null);

    const barColors = totals.map((item) =>
        item.crime === highlightCrime ? "#ffd166" : "#ff5555"
    );
    const customdata = totals.map((item, idx) => [
        item.crime,
        idx + 1,
        shares[idx]
    ]);

    const traces = [
        {
            type: "bar",
            x: labels,
            y: counts,
            marker: { color: barColors },
            name: "Incidents",
            customdata,
            hovertemplate:
                "<b>%{customdata[0]}</b><br>Rank #%{customdata[1]}<br>%{y:,} incidents<br>Share %{customdata[2]}%<extra></extra>",
            offsetgroup: "counts"
        },
        {
            type: "scatter",
            mode: "lines+markers",
            x: labels,
            y: cumulative,
            yaxis: "y2",
            name: "Cumulative %",
            marker: { color: "#00c2ff" },
            line: { color: "#00c2ff", width: 2 },
            hovertemplate:
                "<b>%{x}</b><br>Cumulative %{y:.1f}%<extra></extra>",
            offsetgroup: "line"
        }
    ];

    const layout = {
        ...plotlyBaseLayout,
        margin: { t: 30, b: 200, l: 70, r: 60 },
        xaxis: {
            tickangle: -45,
            tickfont: { size: 11 },
            automargin: true,
            tickmode: "array",
            tickvals: labels.map((_, idx) => idx),
            ticktext: labels.map((label) =>
                label.length > 26 ? `${label.slice(0, 26)}â€¦` : label
            )
        },
        yaxis: {
            title: { text: "Incidents", standoff: 25 },
            separatethousands: true,
            zeroline: false
        },
        yaxis2: {
            title: { text: "Cumulative %", standoff: 35 },
            overlaying: "y",
            side: "right",
            range: [0, 100],
            zeroline: false,
            showgrid: false
        },
        legend: {
            orientation: "h",
            y: 1.06,
            x: 0.5,
            xanchor: "center",
            font: { size: 11 }
        },
        height: 480
    };

    Plotly.react("crime-type-chart", traces, layout, plotlyConfig).then(() =>
        attachParetoInteractions()
    );
}

function attachParetoInteractions() {
    const chartEl = document.getElementById("crime-type-chart");
    if (!chartEl || typeof chartEl.on !== "function") return;
    if (chartEl.__whatClickHandler) {
        chartEl.removeListener?.("plotly_click", chartEl.__whatClickHandler);
    }
    if (chartEl.__whatDoubleHandler) {
        chartEl.removeListener?.("plotly_doubleclick", chartEl.__whatDoubleHandler);
    }

    chartEl.__whatClickHandler = (event) => {
        const crime = event?.points?.[0]?.customdata?.[0];
        if (!crime) return;
        const alreadySelected = whatState.filters.selectedCrime === crime;
        whatState.filters.selectedCrime = alreadySelected ? null : crime;
        updateWhatFilterChip();
        updateWhatCharts();
    };

    chartEl.__whatDoubleHandler = () => {
        if (!whatState.filters.selectedCrime) return false;
        whatState.filters.selectedCrime = null;
        updateWhatFilterChip();
        updateWhatCharts();
        return false;
    };

    chartEl.on("plotly_click", chartEl.__whatClickHandler);
    chartEl.on("plotly_doubleclick", chartEl.__whatDoubleHandler);
}

function renderCrimeSunburstFiltered() {
    const slices = filterSlices(whatState.data?.sunburst, whatState.filters);
    if (!slices.length) {
        renderEmptyState("crime-hierarchy-chart", "No hierarchy for current filters.");
        return;
    }

    const partTotals = new Map();
    const leafTotals = new Map();
    let total = 0;

    slices.forEach((slice) => {
        const key = `${slice.part}|${slice.crime}`;
        leafTotals.set(key, (leafTotals.get(key) || 0) + slice.count);
        partTotals.set(slice.part, (partTotals.get(slice.part) || 0) + slice.count);
        total += slice.count;
    });

    const labels = [];
    const parents = [];
    const values = [];
    const customdata = [];

    for (const [part, value] of partTotals.entries()) {
        labels.push(part);
        parents.push("");
        values.push(value);
        customdata.push(total ? Number(((value / total) * 100).toFixed(2)) : 0);
    }

    for (const [key, value] of leafTotals.entries()) {
        const [part, crime] = key.split("|");
        labels.push(cleanLabel(crime));
        parents.push(part);
        values.push(value);
        customdata.push(total ? Number(((value / total) * 100).toFixed(2)) : 0);
    }

    const trace = [
        {
            type: "sunburst",
            labels,
            parents,
            values,
            branchvalues: "total",
            maxdepth: 3,
            sort: false,
            hovertemplate:
                "<b>%{label}</b><br>%{value:,} incidents<br>Share %{customdata:.2f}%<extra></extra>",
            marker: { line: { color: "#111", width: 1 } },
            customdata
        }
    ];

    const layout = {
        ...plotlyBaseLayout,
        margin: { t: 40, b: 20, l: 20, r: 20 },
        height: 380
    };

    Plotly.react("crime-hierarchy-chart", trace, layout, plotlyConfig);
}

function renderWeaponPremiseFiltered() {
    const slices = filterSlices(
        whatState.data?.weapon_premise?.slices,
        whatState.filters
    );
    if (!slices.length) {
        renderEmptyState(
            "weapon-premise-chart",
            "No weapon-premise combinations for current filters."
        );
        return;
    }

    const matrix = new Map();
    const weaponTotals = new Map();
    const premiseTotals = new Map();
    let total = 0;

    slices.forEach((slice) => {
        const weaponMap = matrix.get(slice.weapon) || new Map();
        weaponMap.set(slice.premise, (weaponMap.get(slice.premise) || 0) + slice.count);
        matrix.set(slice.weapon, weaponMap);
        weaponTotals.set(slice.weapon, (weaponTotals.get(slice.weapon) || 0) + slice.count);
        premiseTotals.set(slice.premise, (premiseTotals.get(slice.premise) || 0) + slice.count);
        total += slice.count;
    });

    let weaponOrder = [...(whatState.data?.categories?.weapons ?? [])];
    let premiseOrder = [...(whatState.data?.categories?.premises ?? [])];
    if (whatState.filters.weaponSort === "desc") {
        weaponOrder.sort(
            (a, b) => (weaponTotals.get(b) || 0) - (weaponTotals.get(a) || 0)
        );
        premiseOrder.sort(
            (a, b) => (premiseTotals.get(b) || 0) - (premiseTotals.get(a) || 0)
        );
    }

    const z = [];
    const customdata = [];
    weaponOrder.forEach((weapon) => {
        const rowMap = matrix.get(weapon) || new Map();
        const row = [];
        const shareRow = [];
        premiseOrder.forEach((premise) => {
            const value = rowMap.get(premise) || 0;
            row.push(value);
            const share = total ? (value / total) * 100 : 0;
            shareRow.push(Number(share.toFixed(2)));
        });
        z.push(row);
        customdata.push(shareRow);
    });

    const flatValues = z.flat();
    const sortedValues = [...flatValues].sort((a, b) => a - b);
    const percentileIdx = Math.floor(sortedValues.length * 0.8);
    let colorCap = sortedValues[percentileIdx] || sortedValues[sortedValues.length - 1] || 1;
    if (colorCap <= 0) {
        colorCap = 1;
    }

    const intermediateCap = colorCap * 0.5;

    const trace = [
        {
            type: "heatmap",
            z,
            x: premiseOrder.map((prem) => cleanLabel(prem)),
            y: weaponOrder.map((weapon) => cleanLabel(weapon)),
            colorscale: "Inferno",
            hoverongaps: false,
            customdata,
            zmin: 0,
            zmax: colorCap,
            zmid: intermediateCap,
            colorbar: {
                title: "Incidents",
                tickformat: "~s"
            },
            hovertemplate:
                "Premises: %{x}<br>Weapon: %{y}<br>%{z:,} incidents<br>Share %{customdata:.2f}%<extra></extra>"
        }
    ];

    const layout = {
        ...plotlyBaseLayout,
        margin: { t: 30, b: 120, l: 140, r: 10 },
        xaxis: {
            tickangle: -55,
            tickfont: { size: 11 },
            automargin: true
        },
        height: 560
    };

    Plotly.react("weapon-premise-chart", trace, layout, plotlyConfig);
}

function renderStatusSankeyFiltered() {
    const slices = filterSlices(
        whatState.data?.status_flow?.slices,
        whatState.filters
    );
    if (!slices.length) {
        renderEmptyState(
            "status-sankey-chart",
            "No status flow for current filters."
        );
        return;
    }

    const flows = [];
    const crimeTotals = new Map();
    const statusTotals = new Map();
    let total = 0;

    slices.forEach((slice) => {
        flows.push(slice);
        crimeTotals.set(slice.crime, (crimeTotals.get(slice.crime) || 0) + slice.count);
        statusTotals.set(slice.status, (statusTotals.get(slice.status) || 0) + slice.count);
        total += slice.count;
    });

    const baseCrimeOrder = whatState.data?.categories?.crimes ?? [];
    const selectedCrime = whatState.filters.selectedCrime;
    let crimeOrder = [];
    if (selectedCrime && crimeTotals.get(selectedCrime)) {
        crimeOrder = [selectedCrime];
    } else {
        crimeOrder = baseCrimeOrder
            .map((crime) => ({ crime, count: crimeTotals.get(crime) || 0 }))
            .filter((item) => item.count > 0)
            .sort((a, b) => b.count - a.count)
            .slice(0, 6)
            .map((item) => item.crime);
    }
    if (!crimeOrder.length) {
        renderEmptyState(
            "status-sankey-chart",
            "No status flow for current filters."
        );
        return;
    }
    const baseStatusOrder = whatState.data?.categories?.statuses ?? [];
    let statusOrder = baseStatusOrder.filter((status) => statusTotals.get(status));
    if (whatState.filters.statusSort === "desc") {
        statusOrder.sort(
            (a, b) => (statusTotals.get(b) || 0) - (statusTotals.get(a) || 0)
        );
    } else {
        statusOrder.sort((a, b) =>
            cleanLabel(a).localeCompare(cleanLabel(b), undefined, { sensitivity: "base" })
        );
    }
    if (!selectedCrime) {
        statusOrder = statusOrder.slice(0, 5);
    }

    const labels = [];
    const crimeIndex = new Map();
    const statusIndex = new Map();

    crimeOrder.forEach((crime) => {
        crimeIndex.set(crime, labels.length);
        labels.push(cleanLabel(crime));
    });

    statusOrder.forEach((status) => {
        statusIndex.set(status, labels.length);
        labels.push(cleanLabel(status));
    });

    const spreadPositions = (count) => {
        if (!count) return [];
        if (count === 1) return [0.5];
        const step = 1 / count;
        return Array.from({ length: count }, (_, idx) => step * idx + step / 2);
    };

    const crimeYPositions = spreadPositions(crimeOrder.length);
    const statusYPositions = spreadPositions(statusOrder.length);
    const nodeX = [];
    const nodeY = [];

    crimeYPositions.forEach((pos) => {
        nodeX.push(0.05);
        nodeY.push(pos);
    });
    statusYPositions.forEach((pos) => {
        nodeX.push(0.95);
        nodeY.push(pos);
    });

    const source = [];
    const target = [];
    const value = [];
    const shares = [];

    flows.forEach((flow) => {
        const sourceIdx = crimeIndex.get(flow.crime);
        const targetIdx = statusIndex.get(flow.status);
        if (sourceIdx === undefined || targetIdx === undefined) return;
        source.push(sourceIdx);
        target.push(targetIdx);
        value.push(flow.count);
        const share = total ? (flow.count / total) * 100 : 0;
        shares.push(Number(share.toFixed(2)));
    });

    const crimePalette = ["#ff6b6b", "#ffd166", "#06d6a0", "#118ab2", "#9b5de5", "#f15bb5"];
    const statusPalette = ["#4cc9f0", "#4895ef", "#560bad", "#b5179e", "#ff9770", "#00bbf0"];
    const nodeColors = labels.map((_, idx) => {
        if (idx < crimeOrder.length) {
            return crimePalette[idx % crimePalette.length];
        }
        const statusIdx = idx - crimeOrder.length;
        return statusPalette[statusIdx % statusPalette.length];
    });

    const trace = [
        {
            type: "sankey",
            orientation: "h",
            node: {
                label: labels,
                x: nodeX,
                y: nodeY,
                pad: 15,
                thickness: 18,
                color: nodeColors,
                line: { color: "#111", width: 1 },
                font: { color: "#ffffff" }
            },
            link: {
                source,
                target,
                value,
                customdata: shares,
                color: source.map((srcIdx) => hexToRGBA(nodeColors[srcIdx], 0.45)),
                hovertemplate:
                    "%{source.label} â†’ %{target.label}<br>%{value:,} incidents<br>Share %{customdata:.2f}%<extra></extra>"
            }
        }
    ];

    const layout = {
        ...plotlyBaseLayout,
        margin: { t: 110, b: 50, l: 50, r: 50 },
        height: 560
    };

    Plotly.react("status-sankey-chart", trace, layout, plotlyConfig);
}

document.addEventListener("DOMContentLoaded", initWhatVisuals);

document.getElementById('weaponSort')?.addEventListener('change', (event) => {
    whatState.filters.weaponSort = event.target.value;
    updateWhatCharts();
});

document.getElementById('statusSort')?.addEventListener('change', (event) => {
    whatState.filters.statusSort = event.target.value;
    updateWhatCharts();
});

document.getElementById('clearWhatFilter')?.addEventListener('click', () => {
    whatState.filters.selectedCrime = null;
    updateWhatFilterChip();
    updateWhatCharts();
});

document.getElementById('weaponSort')?.addEventListener('change', (event) => {
    whatState.filters.weaponSort = event.target.value;
    updateWhatCharts();
});

document.getElementById('statusSort')?.addEventListener('change', (event) => {
    whatState.filters.statusSort = event.target.value;
    updateWhatCharts();
});

document.getElementById('clearWhatFilter')?.addEventListener('click', () => {
    whatState.filters.selectedCrime = null;
    updateWhatFilterChip();
    updateWhatCharts();
});

const whatHelpButton = document.getElementById("whatHelpToggle");
const whatHelpPanel = document.getElementById("whatHelpPanel");
whatHelpButton?.addEventListener("click", () => {
    const expanded = whatHelpButton.getAttribute("aria-expanded") === "true";
    whatHelpButton.setAttribute("aria-expanded", String(!expanded));
    if (whatHelpPanel) {
        whatHelpPanel.style.display = expanded ? "none" : "block";
    }
});



// ============================================
// DATA LOADING AND PROCESSING
// ============================================

async function loadWhoData() {
    try {
        console.log('Loading WHO data...');
        
        // Use Papaparse to load the gzipped CSV (same as multidimensional.html)
        const resp = await fetch('Crime_Data_from_2020_to_Present.csv.gz');
        const gzArrayBuffer = await resp.arrayBuffer();
        const gzUint8 = new Uint8Array(gzArrayBuffer);
        const csvText = pako.ungzip(gzUint8, { to: 'string' });

        return new Promise((resolve, reject) => {
            Papa.parse(csvText, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: (results) => {
                    console.log(`WHO: Loaded ${results.data.length} records`);
                    
                    // Process and clean data
                    const processedData = results.data
                        .filter(row => {
                            // Filter out records with missing key demographic data
                            const age = Number(row['Vict Age']);
                            return age > 0 && age <= 120 && row['Vict Sex'] && row['Crm Cd Desc'];
                        })
                        .map(row => ({
                            'Vict Age': Number(row['Vict Age']),
                            'Vict Sex': (row['Vict Sex'] || 'X').toUpperCase().trim(),
                            'Vict Descent': (row['Vict Descent'] || 'X').toUpperCase().trim(),
                            'Crm Cd Desc': (row['Crm Cd Desc'] || 'UNKNOWN').toString().toUpperCase().trim(),
                            'DATE OCC': row['DATE OCC'] || row['Date Rptd'],
                            'AREA NAME': row['AREA NAME'] || ''
                        }));
                    
                    console.log(`WHO: Processed ${processedData.length} valid records`);
                    resolve(processedData);
                },
                error: (error) => {
                    console.error('WHO: Error parsing CSV:', error);
                    reject(error);
                }
            });
        });
        
    } catch (error) {
        console.error('WHO: Failed to load data:', error);
        throw error;
    }
}

// ============================================
// INITIALIZATION
// ============================================

async function initWhoSection() {
    try {
        console.log('Initializing WHO section...');
        
        // Check if required containers exist
        if (!document.getElementById('pyramid-viz')) {
            console.log('WHO: Containers not found, skipping initialization');
            return;
        }

        // Load data
        whoState.rawData = await loadWhoData();
        whoState.filteredData = whoState.rawData;
        
        // Render all visualizations
        renderPopulationPyramid(whoState.filteredData);
        renderDemographicMix(whoState.filteredData, 'sex');
        renderAgeDistribution(whoState.filteredData);
        
        // Setup event listeners
        setupWhoEventListeners();
        
        console.log('WHO section initialized successfully');
        
    } catch (error) {
        console.error('Failed to initialize WHO section:', error);
        
        // Show error message in containers
        ['pyramid-viz', 'crime-demo-viz', 'age-dist-viz'].forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.innerHTML = '<p style="color:#ff5555;text-align:center;padding:40px;">âš  Unable to load demographic data. Please check console for details.</p>';
            }
        });
    }
}

function setupWhoEventListeners() {
    // Demographic grouping toggle
    const groupingSelect = document.getElementById('demo-grouping');
    if (groupingSelect) {
        groupingSelect.addEventListener('change', function(e) {
            whoState.currentGrouping = e.target.value;
            renderDemographicMix(whoState.filteredData, e.target.value);
        });
    }
    
    // Listen for global filter changes (integrate with your existing filter system)
    document.getElementById('applyFilters')?.addEventListener('click', applyGlobalFiltersToWho);
    document.getElementById('resetFilters')?.addEventListener('click', resetWhoFilters);
}

// ============================================
// FILTER INTEGRATION
// ============================================

function applyGlobalFiltersToWho() {
    console.log('WHO: Applying global filters...');
    
    // Get filter values from global controls
    const startMonth = document.getElementById('globalStart')?.value || 
                      document.getElementById('startDate')?.value || '2020-01';
    const endMonth = document.getElementById('globalEnd')?.value || 
                    document.getElementById('endDate')?.value || '2024-09';
    const crimeFilter = document.getElementById('globalCrimeType')?.value || 
                       document.getElementById('crimeTypeFilter')?.value || 'all';
    const sexFilter = document.getElementById('globalSex')?.value || 'ALL';
    
    // Parse date range
    let start = startMonth ? new Date(startMonth + '-01') : null;
    let end = endMonth ? new Date(endMonth + '-01') : null;
    if (end) end = new Date(end.getFullYear(), end.getMonth() + 1, 1);
    
    // Apply filters
    whoState.filteredData = whoState.rawData.filter(row => {
        // Date filter
        if (row['DATE OCC']) {
            const dateStr = String(row['DATE OCC']).split(' ')[0];
            const parts = dateStr.split('/');
            if (parts.length === 3) {
                const rowDate = new Date(parts[2], parts[0] - 1, parts[1]);
                if (start && rowDate < start) return false;
                if (end && rowDate >= end) return false;
            }
        }
        
        // Crime type filter
        if (crimeFilter !== 'all' && crimeFilter !== 'ALL') {
            const crimeDesc = row['Crm Cd Desc'].toUpperCase();
            const filterUpper = crimeFilter.toUpperCase().replace(/-/g, ' ');
            if (!crimeDesc.includes(filterUpper)) return false;
        }
        
        // Sex filter (from global or demographic-specific)
        if (sexFilter !== 'ALL') {
            if (row['Vict Sex'] !== sexFilter) return false;
        }
        
        // Check sex checkboxes (if using the checkbox-based filter)
        const maleChecked = document.getElementById('filterMale')?.checked ?? true;
        const femaleChecked = document.getElementById('filterFemale')?.checked ?? true;
        const otherChecked = document.getElementById('filterOther')?.checked ?? true;
        
        const sex = row['Vict Sex'];
        if (sex === 'M' && !maleChecked) return false;
        if (sex === 'F' && !femaleChecked) return false;
        if (sex !== 'M' && sex !== 'F' && !otherChecked) return false;
        
        return true;
    });
    
    console.log(`WHO: Filtered to ${whoState.filteredData.length} records`);
    
    // Re-render visualizations
    renderPopulationPyramid(whoState.filteredData);
    renderDemographicMix(whoState.filteredData, whoState.currentGrouping);
    renderAgeDistribution(whoState.filteredData);
}

function resetWhoFilters() {
    whoState.filteredData = whoState.rawData;
    whoState.selectedDemographic = null;
    
    renderPopulationPyramid(whoState.filteredData);
    renderDemographicMix(whoState.filteredData, whoState.currentGrouping);
    renderAgeDistribution(whoState.filteredData);
}

// ============================================
// 1. POPULATION PYRAMID
// ============================================

function renderPopulationPyramid(data) {
    const validData = data.filter(d => 
        d['Vict Age'] > 0 && 
        d['Vict Age'] <= 100 && 
        (d['Vict Sex'] === 'M' || d['Vict Sex'] === 'F')
    );

    if (validData.length === 0) {
        document.getElementById('pyramid-viz').innerHTML = 
            '<p style="color:#cccccc;text-align:center;padding:40px;">No data available for current filters</p>';
        return;
    }

    const aggregated = WHO_AGE_BINS.map(bin => {
        const maleCount = validData.filter(d => 
            d['Vict Age'] >= bin.min && 
            d['Vict Age'] <= bin.max && 
            d['Vict Sex'] === 'M'
        ).length;
        
        const femaleCount = validData.filter(d => 
            d['Vict Age'] >= bin.min && 
            d['Vict Age'] <= bin.max && 
            d['Vict Sex'] === 'F'
        ).length;

        return {
            ageGroup: bin.label,
            male: -maleCount,
            maleAbs: maleCount,
            female: femaleCount
        };
    });

    const maleTrace = {
        type: 'bar',
        y: aggregated.map(d => d.ageGroup),
        x: aggregated.map(d => d.male),
        name: 'Male',
        orientation: 'h',
        marker: { color: '#3498db', line: { color: '#2980b9', width: 1 } },
        hovertemplate: '<b>Male</b><br>Age: %{y}<br>Count: %{customdata:,}<extra></extra>',
        customdata: aggregated.map(d => d.maleAbs)
    };

    const femaleTrace = {
        type: 'bar',
        y: aggregated.map(d => d.ageGroup),
        x: aggregated.map(d => d.female),
        name: 'Female',
        orientation: 'h',
        marker: { color: '#e74c3c', line: { color: '#c0392b', width: 1 } },
        hovertemplate: '<b>Female</b><br>Age: %{y}<br>Count: %{x:,}<extra></extra>'
    };

    const layout = {
        ...plotlyBaseLayout,
        barmode: 'overlay',
        xaxis: {
            title: 'Number of Victims',
            tickformat: ',d',
            gridcolor: '#333',
            zerolinecolor: '#ffffff',
            zerolinewidth: 2
        },
        yaxis: { 
            title: 'Age Group',
            autorange: 'reversed',
            gridcolor: '#333'
        },
        height: 450,
        margin: { l: 80, r: 80, t: 30, b: 80 },
        showlegend: true,
        legend: { x: 0.5, xanchor: 'center', y: -0.15, orientation: 'h' }
    };

    Plotly.newPlot('pyramid-viz', [maleTrace, femaleTrace], layout, plotlyConfig);
    
    // Add click handler for cross-filtering
    document.getElementById('pyramid-viz').on('plotly_click', function(eventData) {
        const point = eventData.points[0];
        const ageGroup = point.y;
        const sex = point.data.name === 'Male' ? 'M' : 'F';
        handleDemographicSelection(ageGroup, sex);
    });
}

// ============================================
// 2. DEMOGRAPHIC MIX BY CRIME TYPE
// ============================================

function renderDemographicMix(data, groupBy) {
    const crimeCounts = {};
    data.forEach(d => {
        const crime = d['Crm Cd Desc'];
        crimeCounts[crime] = (crimeCounts[crime] || 0) + 1;
    });
    
    const topCrimes = Object.entries(crimeCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 6)
        .map(d => d[0]);

    if (topCrimes.length === 0) {
        document.getElementById('crime-demo-viz').innerHTML = 
            '<p style="color:#cccccc;text-align:center;padding:40px;">No data available for current filters</p>';
        return;
    }

    let categories, colors, getLabel;
    
    if (groupBy === 'sex') {
        categories = ['M', 'F', 'X'];
        colors = ['#3498db', '#e74c3c', '#95a5a6'];
        getLabel = (cat) => cat === 'M' ? 'Male' : cat === 'F' ? 'Female' : 'Other/Unknown';
    } else {
        // For descent, get top 5 most common
        const descentCounts = {};
        data.forEach(d => {
            const desc = d['Vict Descent'];
            descentCounts[desc] = (descentCounts[desc] || 0) + 1;
        });
        categories = Object.entries(descentCounts)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 5)
            .map(d => d[0]);
        colors = ['#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6'];
        getLabel = (cat) => DESCENT_LABELS[cat] || cat;
    }

    const traces = categories.map((category, idx) => {
        const counts = topCrimes.map(crime => {
            return data.filter(d => 
                d['Crm Cd Desc'] === crime && 
                (groupBy === 'sex' ? d['Vict Sex'] : d['Vict Descent']) === category
            ).length;
        });

        return {
            type: 'bar',
            x: topCrimes.map(c => {
                // Capitalize first letter of each word
                const words = c.toLowerCase().split(' ');
                const capitalized = words.map(w => w.charAt(0).toUpperCase() + w.slice(1));
                const formatted = capitalized.join(' ');
                return formatted.length > 20 ? formatted.substring(0, 20) + '...' : formatted;
            }),
            y: counts,
            name: getLabel(category),
            marker: { color: colors[idx % colors.length] },
            hovertemplate: '<b>%{x}</b><br>' + getLabel(category) + ': %{y:,}<extra></extra>'
        };
    });

    const layout = {
        ...plotlyBaseLayout,
        barmode: 'stack',
        xaxis: { title: 'Crime Type', tickangle: -45, gridcolor: '#333' },
        yaxis: { title: 'Victim Count', gridcolor: '#333' },
        height: 420,
        margin: { l: 60, r: 30, t: 30, b: 150 }
    };

    Plotly.newPlot('crime-demo-viz', traces, layout, plotlyConfig);
}

// ============================================
// 3. AGE DISTRIBUTION BY CRIME TYPE
// ============================================

function renderAgeDistribution(data) {
    const crimeCounts = {};
    data.forEach(d => {
        const crime = d['Crm Cd Desc'];
        crimeCounts[crime] = (crimeCounts[crime] || 0) + 1;
    });
    
    const topCrimes = Object.entries(crimeCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 8)
        .map(d => d[0]);

    if (topCrimes.length === 0) {
        document.getElementById('age-dist-viz').innerHTML = 
            '<p style="color:#cccccc;text-align:center;padding:40px;">No data available for current filters</p>';
        return;
    }

    const colors = [
        '#3498db', '#e74c3c', '#2ecc71', '#f39c12', 
        '#9b59b6', '#1abc9c', '#e67e22', '#34495e'
    ];

    const traces = topCrimes.map((crime, i) => {
        const ages = data
            .filter(d => 
                d['Crm Cd Desc'] === crime && 
                d['Vict Age'] > 0 && 
                d['Vict Age'] <= 100
            )
            .map(d => d['Vict Age']);

        // Capitalize crime name
        const words = crime.toLowerCase().split(' ');
        const capitalized = words.map(w => w.charAt(0).toUpperCase() + w.slice(1));
        const formatted = capitalized.join(' ');
        const displayName = formatted.length > 25 ? formatted.substring(0, 25) + '...' : formatted;

        return {
            type: 'violin',
            y: ages,
            name: displayName,
            box: { visible: true },
            meanline: { visible: true },
            marker: { color: colors[i % colors.length] },
            line: { color: colors[i % colors.length] },
            hoverinfo: 'y+name',
            points: false
        };
    });

    const layout = {
        ...plotlyBaseLayout,
        yaxis: { title: 'Victim Age', range: [0, 100], gridcolor: '#333' },
        xaxis: { title: 'Crime Type', tickangle: -35, gridcolor: '#333' },
        height: 420,
        margin: { l: 60, r: 30, t: 30, b: 150 },
        showlegend: false
    };

    Plotly.newPlot('age-dist-viz', traces, layout, plotlyConfig);
}

// ============================================
// CROSS-FILTERING HANDLER
// ============================================

function handleDemographicSelection(ageGroup, sex) {
    console.log(`WHO: Selected demographic - Age: ${ageGroup}, Sex: ${sex}`);
    
    whoState.selectedDemographic = { ageGroup, sex };
    
    // TODO: Emit event for other sections to listen to
    // For now, just log - you can integrate with your global filter system
    
    // Example of how to filter data
    const [minAge, maxAge] = ageGroup.includes('+') 
        ? [parseInt(ageGroup), 100]
        : ageGroup.split('-').map(Number);
    
    const filtered = whoState.filteredData.filter(d => 
        d['Vict Age'] >= minAge && 
        d['Vict Age'] <= maxAge && 
        d['Vict Sex'] === sex
    );
    
    console.log(`WHO: Filtered to ${filtered.length} records for selected demographic`);
    
    // You can dispatch a custom event here to update other sections:
    // document.dispatchEvent(new CustomEvent('whoFilterChanged', {
    //     detail: { ageGroup, sex, data: filtered }
    // }));
}

// ============================================
// AUTO-INITIALIZE WHEN DOM IS READY
// ============================================

// Initialize WHO section when page loads
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        // Wait a bit for other sections to load first
        setTimeout(initWhoSection, 500);
    });
} else {
    // DOM already loaded
    setTimeout(initWhoSection, 500);
}
</script>


</body>
</html>
